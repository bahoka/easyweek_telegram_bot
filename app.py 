from flask import Flask, request, jsonify
import json
import os
import requests

app = Flask(__name__)

TELEGRAM_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
USERS_FILE = "users.json"

def load_users():
    if os.path.exists(USERS_FILE):
        with open(USERS_FILE, "r") as f:
            return json.load(f)
    return {}

def send_telegram_message(chat_id, text):
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    requests.post(url, json={"chat_id": chat_id, "text": text})

@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.json
    print("üîî Webhook received:", data)

    phone = data.get("phone") or data.get("client", {}).get("phone")
    if not phone:
        return jsonify({"error": "Phone not found"}), 400

    phone = phone.replace(" ", "").replace("+", "").replace("-", "")

    users = load_users()
    tg_id = users.get(phone)

    if tg_id:
        service = data.get("service", {}).get("name", "—É—Å–ª—É–≥–∞")
        time = data.get("start", "–≤—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ")
        msg = f"üìÖ –í—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ {service} –≤ {time}"
        send_telegram_message(tg_id, msg)

    return jsonify({"status": "ok"}), 200
